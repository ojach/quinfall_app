<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>タリスマン強化シミュ Ver.2</title>
  <style>
    :root {
      --bg: #ffffff;
      --fg: #222222;
      --card: #f7f7f7;
      --line: #dddddd;
      --muted: #888888;
      --accent: #2b6cb0;
    }
    body {
      margin: 0;
      padding: 12px;
      font-family: "Hiragino Kaku Gothic ProN","Noto Sans JP",sans-serif;
      background: var(--bg);
      color: var(--fg);
    }
    h1 {
      margin: 0 0 8px;
      font-size: 18px;
    }
    .top-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-bottom: 8px;
    }
    .top-bar .spacer {
      flex: 1 1 auto;
    }
    .badge {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid var(--line);
      background: #fff;
      margin-left: 4px;
    }
    .level-select {
      display: inline-flex;
      gap: 4px;
      align-items: center;
      font-size: 13px;
    }
    .level-select button {
      padding: 4px 8px;
      border-radius: 999px;
      border: 1px solid var(--line);
      background: #fff;
      cursor: pointer;
      font-size: 12px;
    }
    .level-select button.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
    }
    .container {
      display: grid;
      grid-template-columns: minmax(0, 1.2fr) minmax(0, 1fr);
      gap: 10px;
    }
    .card {
      background: var(--card);
      border-radius: 8px;
      border: 1px solid var(--line);
      padding: 10px;
    }
    .section-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }
    .muted { color: var(--muted); font-size: 12px; }

    /* 装備フォーム */
    .slot-list { display: flex; flex-direction: column; gap: 6px; }
    .slot-row {
      display: grid;
      grid-template-columns: 70px minmax(0, 1.2fr) 90px;
      gap: 6px;
      align-items: center;
    }
    .slot-label { font-size: 12px; }
    select {
      width: 100%;
      padding: 4px 6px;
      border-radius: 4px;
      border: 1px solid var(--line);
      font-size: 12px;
      background: #fff;
    }

    /* パワーストーン */
    .ps-row {
      display: grid;
      grid-template-columns: 70px minmax(0,1.2fr);
      gap: 6px;
      align-items: center;
      margin-bottom: 4px;
    }

    /* 結果 */
    .totals { margin-bottom: 10px; }
    .stat-table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .stat-table th, .stat-table td {
      padding: 4px 6px;
      border-bottom: 1px solid var(--line);
    }
    .stat-table th { text-align: left; background:#f0f0f0; }
    .stat-name { min-width: 80px; }
    .break-section { margin-top: 10px; font-size: 12px; }
    .break-block {
      border-radius: 6px;
      background: #fff;
      border: 1px solid var(--line);
      padding: 6px 8px;
      margin-bottom: 6px;
    }
    .tag {
      display: inline-block;
      padding: 2px 6px;
      border-radius: 4px;
      font-size: 10px;
      border: 1px solid var(--line);
      background: #fff;
      margin-right: 4px;
    }

    /* レスポンシブ */
    @media (max-width: 900px) {
      .container {
        grid-template-columns: 1fr;
      }
      .slot-row {
        grid-template-columns: 60px minmax(0, 1fr);
        grid-template-rows: auto auto;
      }
      .slot-row select:nth-child(2) { grid-column: 2 / 3; }
    }
  </style>
</head>
<body>
  <h1>タリスマン強化シミュ Ver.2 <span class="badge">試作</span></h1>

  <div class="top-bar">
    <div class="level-select" id="levelSelect">
      <span>装備レベル:</span>
      <button data-level="60">60</button>
      <button data-level="75">75</button>
      <button data-level="100">100</button>
      <button data-level="110" class="active">110</button>
    </div>

    <label style="font-size:12px; margin-left:12px;">
      <input type="checkbox" id="useShield" checked> 盾スロットを使う
    </label>

    <div class="spacer"></div>
  </div>

  <div class="container">
    <!-- 左：装備＋パワーストーン -->
    <div class="card">
      <div class="section-title">装備スロット &amp; タリスマン</div>
      <div class="slot-list" id="slotArea"></div>

      <hr style="margin:10px 0; border:none; border-top:1px solid var(--line);" />

      <div class="section-title">パワーストーン（共通・重複不可 / 3枠仮実装）</div>
      <div id="psArea"></div>
      <div class="muted">※ とりあえず全体3枠版。将来は各装備3枠に拡張も可。</div>
    </div>

    <!-- 右：結果 -->
    <div class="card">
      <div class="totals">
        <div class="section-title">合計ステータス</div>
        <div id="totalArea" class="muted">タリスマン or パワーストーンを選択してください。</div>
      </div>

      <div class="break-section">
        <div class="section-title">内訳（セット効果 / パワーストーン）</div>
        <div id="breakArea" class="muted">まだ何も発動していません。</div>
      </div>
    </div>
  </div>

<script>
/* =======================
   データ定義（ステ辞書）
   ======================= */
// kind = "flat" or "percent"
const STAT_DEFS = {
  "物理攻撃力": {
    ui: "物攻",
    tooltip: "Physical Attack",
    kind: "flat",
    lv: { 60: 66, 75: 82.5, 100: 110, 110: 121 }
  },
  "物理防御力": {
    ui: "物防",
    tooltip: "Physical Defense",
    kind: "flat",
    lv: { 60: 66, 75: 82.5, 100: 110, 110: 121 }
  },
  "魔法攻撃力": {
    ui: "魔攻",
    tooltip: "Magic Attack",
    kind: "flat",
    lv: { 60: 66, 75: 82.5, 100: 110, 110: 121 }
  },
  "魔法防御力": {
    ui: "魔防",
    tooltip: "Magic Defense",
    kind: "flat",
    lv: { 60: 66, 75: 82.5, 100: 110, 110: 121 }
  },
  "HP": {
    ui: "HP",
    tooltip: "Hit Points",
    kind: "flat",
    lv: { 60: 600, 75: 750, 100: 1000, 110: 1100 }
  },
  "MP": {
    ui: "MP",
    tooltip: "Mana Points",
    kind: "flat",
    lv: { 60: 600, 75: 750, 100: 1000, 110: 1100 }
  },
  "HP再生": {
    ui: "HP再",
    tooltip: "HP Regen",
    kind: "flat",
    lv: { 60: 54, 75: 67.5, 100: 90, 110: 99 }
  },
  "MP再生": {
    ui: "MP再",
    tooltip: "MP Regen",
    kind: "flat",
    lv: { 60: 54, 75: 67.5, 100: 90, 110: 99 }
  },
  "回復倍率": {
    ui: "回復",
    tooltip: "Healing Bonus",
    kind: "percent",
    lv: { 60: 0.1, 75: 0.1, 100: 0.1, 110: 0.1 }
  },
  "命中": {
    ui: "命中",
    tooltip: "Accuracy",
    kind: "flat",
    lv: { 60: 42, 75: 52.5, 100: 70, 110: 77 }
  },
  "回避": {
    ui: "回避",
    tooltip: "Evasion",
    kind: "flat",
    lv: { 60: 36, 75: 45, 100: 60, 110: 66 }
  },
  "移動速度": {
    ui: "移速",
    tooltip: "Movement Speed",
    kind: "flat",
    lv: { 60: 4, 75: 4, 100: 4, 110: 4 }
  },
  "クリティカル発生率": {
    ui: "クリ率",
    tooltip: "Critical Hit Rate",
    kind: "percent",
    lv: { 60: 0.1, 75: 0.1, 100: 0.1, 110: 0.1 }
  },
  "クリティカル倍率": {
    ui: "クリ倍",
    tooltip: "Critical Damage",
    kind: "percent",
    lv: { 60: 0.05, 75: 0.05, 100: 0.05, 110: 0.05 }
  }
};

/* =======================
   パワーストーン
   - 「パワーストーン」列を名前に
   - 一部名称をステ名に合わせて集計
   ======================= */
const POWERSTONES = {
  "物理攻撃": {
    ui: "物攻",
    tooltip: "Physical Attack",
    // 紐付けるステ名
    stat: "物理攻撃力",
    kind: "flat",
    lv: { 60: 21, 75: 26, 100: 32, 110: 38 }
  },
  "魔法攻撃": {
    ui: "魔攻",
    tooltip: "Magic Attack",
    stat: "魔法攻撃力",
    kind: "flat",
    lv: { 60: 21, 75: 26, 100: 32, 110: 38 }
  },
  "物理防御": {
    ui: "物防",
    tooltip: "Physical Defense",
    stat: "物理防御力",
    kind: "flat",
    lv: { 60: 21, 75: 26, 100: 32, 110: 38 }
  },
  "魔法防御": {
    ui: "魔防",
    tooltip: "Magic Defense",
    stat: "魔法防御力",
    kind: "flat",
    lv: { 60: 21, 75: 26, 100: 32, 110: 38 }
  },
  "HP": {
    ui: "HP",
    tooltip: "Hit Points",
    stat: "HP",
    kind: "flat",
    lv: { 60: 350, 75: 450, 100: 600, 110: 750 }
  },
  "MP": {
    ui: "MP",
    tooltip: "MP",
    stat: "MP",
    kind: "flat",
    lv: { 60: 175, 75: 225, 100: 300, 110: 375 }
  },
  "HP回復": {
    ui: "HP再",
    tooltip: "HP Regen",
    stat: "HP再生",
    kind: "flat",
    lv: { 60: 12, 75: 13, 100: 14, 110: 15 }
  },
  "MP回復": {
    ui: "MP再",
    tooltip: "MP Regen",
    stat: "MP再生",
    kind: "flat",
    lv: { 60: 12, 75: 13, 100: 14, 110: 15 }
  },
  "命中率": {
    ui: "命中",
    tooltip: "Accuracy",
    stat: "命中",
    kind: "flat",
    lv: { 60: 8, 75: 9, 100: 9, 110: 9 }
  },
  "回避率": {
    ui: "回避",
    tooltip: "Evasion",
    stat: "回避",
    kind: "flat",
    lv: { 60: 6, 75: 7, 100: 7, 110: 7 }
  },
  "クリティカル率": {
    ui: "クリ率",
    tooltip: "Critical Hit Rate",
    stat: "クリティカル発生率",
    kind: "percent",
    lv: { 60: 1.1, 75: 1.2, 100: 1.3, 110: 1.3 }
  },
  "クリティカル防御率": {
    ui: "クリ倍",
    tooltip: "Critical Damage",
    stat: "クリティカル倍率",
    kind: "percent",
    lv: { 60: 0.9, 75: 1.0, 100: 1.0, 110: 1.0 }
  }
};

/* =======================
   タリスマン（セット構成）
   - ステ名は STAT_DEFS に紐付け
   ======================= */

const TALISMANS = {
  "ソブリンの遺産": {
    en: "Soverign's Legacy",
    uncommon: { set4: ["物理防御力","HP"] },
    rare: {
      set3: ["物理防御力","魔法防御力"],
      set4: ["物理防御力","魔法防御力","HP"]
    },
    legendary: {
      set2: ["物理攻撃力","物理防御力"],
      set3: ["物理攻撃力","物理防御力","魔法防御力"],
      set4: ["物理攻撃力","物理防御力","魔法防御力","HP"]
    }
  },
  "ラヴェジャーの支配": {
    en: "Ravager's Dominiom",
    uncommon: { set4: ["物理攻撃力","HP"] },
    rare: {
      set3: ["物理攻撃力","物理防御力"],
      set4: ["物理攻撃力","物理防御力","HP"]
    },
    legendary: {
      set2: ["物理攻撃力","物理防御力"],
      set3: ["物理攻撃力","物理防御力","魔法防御力"],
      set4: ["物理攻撃力","物理防御力","魔法防御力","HP"]
    }
  },
  "神聖なる盾": {
    en: "Divine Aegis",
    uncommon: { set4: ["HP","回復倍率"] },
    rare: {
      set3: ["物理防御力","HP"],
      set4: ["物理防御力","HP","回復倍率"]
    },
    legendary: {
      set2: ["物理防御力","魔法防御力"],
      set3: ["物理防御力","魔法防御力","HP"],
      set4: ["物理防御力","魔法防御力","HP","回復倍率"]
    }
  },
  "テンペストバウンド": {
    en: "Tempestbound",
    uncommon: { set4: ["物理防御力","HP"] },
    rare: {
      set3: ["物理攻撃力","物理防御力"],
      set4: ["物理攻撃力","物理防御力","HP"]
    },
    legendary: {
      set2: ["物理攻撃力","物理防御力"],
      set3: ["物理攻撃力","物理防御力","魔法防御力"],
      set4: ["物理攻撃力","物理防御力","魔法防御力","HP"]
    }
  },
  "ブレードウィーバー": {
    en: "Bladeweaver",
    uncommon: { set4: ["物理攻撃力","HP"] },
    rare: {
      set3: ["物理攻撃力","物理防御力"],
      set4: ["物理攻撃力","物理防御力","HP"]
    },
    legendary: {
      set2: ["物理攻撃力","物理防御力"],
      set3: ["物理攻撃力","物理防御力","魔法防御力"],
      set4: ["物理攻撃力","物理防御力","魔法防御力","HP"]
    }
  },
  "スペルファイア": {
    en: "Spellfire",
    uncommon: { set4: ["魔法攻撃力","HP"] },
    rare: {
      set3: ["魔法攻撃力","物理防御力"],
      set4: ["魔法攻撃力","物理防御力","HP"]
    },
    legendary: {
      set2: ["魔法攻撃力","物理防御力"],
      set3: ["魔法攻撃力","物理防御力","魔法防御力"],
      set4: ["魔法攻撃力","物理防御力","魔法防御力","HP"]
    }
  },
  "アストラル・コンフラックス": {
    en: "Astral Confiux",
    uncommon: { set4: ["魔法攻撃力","MP"] },
    rare: {
      set3: ["魔法攻撃力","HP"],
      set4: ["魔法攻撃力","HP","MP"]
    },
    legendary: {
      set2: ["魔法攻撃力","物理防御力"],
      set3: ["魔法攻撃力","物理防御力","HP"],
      set4: ["魔法攻撃力","物理防御力","HP","MP"]
    }
  },
  "セラフィックグレース": {
    en: "Seraphic Grace",
    uncommon: { set4: ["MP","回復倍率"] },
    rare: {
      set3: ["HP","MP"],
      set4: ["HP","MP","回復倍率"]
    },
    legendary: {
      set2: ["物理防御力","HP"],
      set3: ["物理防御力","HP","MP"],
      set4: ["物理防御力","HP","MP","回復倍率"]
    }
  },
  "勇気の砦": {
    en: "Fortress of Valor",
    uncommon: { set4: ["MP再生","回避"] },
    rare: {
      set3: ["MP再生","回避"],
      set4: ["MP再生","回避","移動速度"]
    },
    legendary: {
      set2: ["HP再生","MP再生"],
      set3: ["HP再生","MP再生","回避"],
      set4: ["HP再生","MP再生","回避","移動速度"]
    }
  },
  "ドラゴンクロー": {
    en: "Dragonclaw",
    uncommon: { set4: ["命中","クリティカル発生率"] },
    rare: {
      set3: ["命中","クリティカル発生率"],
      set4: ["命中","クリティカル発生率","クリティカル倍率"]
    },
    legendary: {
      set2: ["HP再生","命中"],
      set3: ["HP再生","命中","クリティカル発生率"],
      set4: ["HP再生","命中","クリティカル発生率","クリティカル倍率"]
    }
  },
  "エルドリッチ・カタリスト": {
    en: "Eldritch Catalyst",
    uncommon: { set4: ["MP再生","クリティカル発生率"] },
    rare: {
      set3: ["HP再生","MP再生"],
      set4: ["HP再生","MP再生","クリティカル発生率"]
    },
    legendary: {
      set2: ["HP再生","MP再生"],
      set3: ["HP再生","MP再生","クリティカル発生率"],
      set4: ["HP再生","MP再生","クリティカル発生率","クリティカル倍率"]
    }
  },
  "神聖なる調和": {
    en: "Divine Harmony",
    uncommon: { set4: ["HP再生","MP再生"] },
    rare: {
      set3: ["HP再生","MP再生"],
      set4: ["HP再生","MP再生","回復倍率"]
    },
    legendary: {
      set2: ["HP再生","MP再生"],
      set3: ["HP再生","MP再生","回避"],
      set4: ["HP再生","MP再生","回避","回復倍率"]
    }
  }
};

/* =======================
   レアリティ略称
   ======================= */
const RARITY_ALIAS = {
  "uncommon": { ui: "UNC", tooltip: "Uncommon（アンコモン）" },
  "rare": { ui: "RARE", tooltip: "Rare（レア）" },
  "legendary": { ui: "LEG", tooltip: "Legendary（レジェンダリー）" }
};

/* =======================
   UI生成
   ======================= */
const ALL_SLOTS = [
  "武器","頭","胴体","腕","足","首飾り",
  "指輪1","指輪2","イヤリング1","イヤリング2","腕輪","かばん","盾"
];
let currentSlots = [...ALL_SLOTS];
let currentLevel = 110;

const slotArea = document.getElementById("slotArea");
const psArea = document.getElementById("psArea");
const totalArea = document.getElementById("totalArea");
const breakArea = document.getElementById("breakArea");

function buildSlots() {
  slotArea.innerHTML = "";
  currentSlots.forEach(slotName => {
    if (slotName === "盾" && !document.getElementById("useShield").checked) return;
    const row = document.createElement("div");
    row.className = "slot-row";
    const talOpt = Object.keys(TALISMANS)
      .map(name => `<option value="${name}">${name}</option>`).join("");
    row.innerHTML = `
      <div class="slot-label">${slotName}</div>
      <select class="tal-select">
        <option value="">（なし）</option>
        ${talOpt}
      </select>
      <select class="rarity-select">
        <option value="legendary">LEG</option>
        <option value="rare">RARE</option>
        <option value="uncommon">UNC</option>
      </select>
    `;
    slotArea.appendChild(row);
  });
  slotArea.querySelectorAll("select").forEach(sel => {
    sel.addEventListener("change", updateAll);
  });
}

function buildPowerStoneUI() {
  psArea.innerHTML = "";
  for (let i = 1; i <= 3; i++) {
    const row = document.createElement("div");
    row.className = "ps-row";
    const opts = Object.keys(POWERSTONES)
      .map(name => {
        const ps = POWERSTONES[name];
        return `<option value="${name}" title="${ps.tooltip}">${name}（${ps.ui}）</option>`;
      }).join("");
    row.innerHTML = `
      <div class="slot-label">PS${i}</div>
      <select class="ps-select">
        <option value="">（なし）</option>
        ${opts}
      </select>
    `;
    psArea.appendChild(row);
  }
  psArea.querySelectorAll("select").forEach(sel => {
    sel.addEventListener("change", onPowerStoneChange);
  });
}

/* 重複チェック：同じ名前を選んだら戻す */
function onPowerStoneChange(e) {
  const selects = [...document.querySelectorAll(".ps-select")];
  const used = new Set();
  for (const s of selects) {
    const v = s.value;
    if (!v) continue;
    if (used.has(v)) {
      alert("同じパワーストーンは重複装備できません。");
      s.value = "";
    } else {
      used.add(v);
    }
  }
  updateAll();
}

/* =======================
   計算ロジック
   ======================= */
function updateAll() {
  const talSelections = [];
  document.querySelectorAll(".slot-row").forEach(row => {
    const talSel = row.querySelector(".tal-select");
    const raritySel = row.querySelector(".rarity-select");
    if (!talSel || !raritySel) return;
    const tn = talSel.value;
    const r = raritySel.value;
    if (tn) talSelections.push({ name: tn, rarity: r });
  });

  const psSelections = [...document.querySelectorAll(".ps-select")]
    .map(s => s.value).filter(Boolean);

  if (talSelections.length === 0 && psSelections.length === 0) {
    totalArea.innerHTML = '<div class="muted">タリスマン or パワーストーンを選択してください。</div>';
    breakArea.innerHTML = '<div class="muted">まだ何も発動していません。</div>';
    return;
  }

  const totalsFlat = {};
  const totalsPct = {};

  const breakdownEntries = [];

  // --- タリスマン集計 ---
  const perName = {};
  talSelections.forEach(sel => {
    if (!perName[sel.name]) perName[sel.name] = [];
    perName[sel.name].push(sel.rarity);
  });

  const rarityOrder = { "uncommon":0, "rare":1, "legendary":2 };

  for (const name in perName) {
    const arr = perName[name];
    const count = arr.length;
    let effRarity = "uncommon";
    arr.forEach(r => {
      if (rarityOrder[r] > rarityOrder[effRarity]) effRarity = r;
    });

    const tal = TALISMANS[name];
    if (!tal) continue;

    let setKey = null;
    if (effRarity === "uncommon") {
      if (count >= 4) setKey = "set4";
    } else if (effRarity === "rare") {
      if (count === 3) setKey = "set3";
      else if (count >= 4) setKey = "set4";
    } else if (effRarity === "legendary") {
      if (count === 2) setKey = "set2";
      else if (count === 3) setKey = "set3";
      else if (count >= 4) setKey = "set4";
    }

    if (setKey && tal[effRarity] && tal[effRarity][setKey]) {
      const statList = tal[effRarity][setKey];
      const gainedStats = [];

      statList.forEach(statName => {
        const def = STAT_DEFS[statName];
        if (!def) return;
        const lvVal = def.lv[currentLevel] ?? 0;
        if (def.kind === "percent") {
          totalsPct[statName] = (totalsPct[statName] || 0) + lvVal;
        } else {
          totalsFlat[statName] = (totalsFlat[statName] || 0) + lvVal;
        }
        gainedStats.push({ name: statName, val: lvVal, kind: def.kind });
      });

      breakdownEntries.push({
        type: "talisman",
        talName: name,
        rarity: effRarity,
        count,
        setKey,
        stats: gainedStats
      });
    }
  }

  // --- パワーストーン集計 ---
  psSelections.forEach(name => {
    const p = POWERSTONES[name];
    if (!p) return;
    const statName = p.stat;
    const def = STAT_DEFS[statName];
    const lvVal = p.lv[currentLevel] ?? 0;
    if (p.kind === "percent" || (def && def.kind === "percent")) {
      totalsPct[statName] = (totalsPct[statName] || 0) + lvVal;
    } else {
      totalsFlat[statName] = (totalsFlat[statName] || 0) + lvVal;
    }
    breakdownEntries.push({
      type: "powerstone",
      psName: name,
      stats: [{ name: statName, val: lvVal, kind: (def ? def.kind : p.kind) }]
    });
  });

  // --- 合計表示 ---
  const statLines = [];

  const allStatNames = new Set([
    ...Object.keys(totalsFlat),
    ...Object.keys(totalsPct)
  ]);
  const sortedNames = [...allStatNames].sort();

  sortedNames.forEach(statName => {
    const def = STAT_DEFS[statName];
    const label = def ? def.ui : statName;
    const tooltip = def ? def.tooltip : statName;
    let textVal = "";
    if (totalsFlat[statName] != null) {
      textVal = totalsFlat[statName];
    }
    if (totalsPct[statName] != null) {
      const v = totalsPct[statName];
      const disp = Math.round(v * 100 * 100) / 100;
      textVal = (textVal ? textVal + " / " : "") + disp + "%";
    }
    statLines.push(`
      <tr>
        <td class="stat-name" title="${tooltip}">${label}</td>
        <td>${textVal}</td>
      </tr>
    `);
  });

  if (statLines.length === 0) {
    totalArea.innerHTML = '<div class="muted">発動中のステータスはありません。</div>';
  } else {
    totalArea.innerHTML = `
      <table class="stat-table">
        <thead><tr><th>ステータス</th><th>合計</th></tr></thead>
        <tbody>${statLines.join("")}</tbody>
      </table>
    `;
  }

  // --- 内訳表示 ---
  if (breakdownEntries.length === 0) {
    breakArea.innerHTML = '<div class="muted">まだ何も発動していません。</div>';
  } else {
    let html = "";
    breakdownEntries.forEach(entry => {
      if (entry.type === "talisman") {
        const r = RARITY_ALIAS[entry.rarity];
        const tal = TALISMANS[entry.talName];
        html += `<div class="break-block">
          <div>
            <span class="tag" title="${tal.en}">${entry.talName}</span>
            <span class="tag" title="${r.tooltip}">${r.ui}</span>
            <span class="tag">${entry.count}個 → ${entry.setKey.toUpperCase()}</span>
          </div>
          <ul style="margin:4px 0 0 16px; padding:0;">`;
        entry.stats.forEach(s => {
          const def = STAT_DEFS[s.name];
          const label = def ? def.ui : s.name;
          const tooltip = def ? def.tooltip : s.name;
          let valText = s.val;
          if (def && def.kind === "percent") {
            valText = (Math.round(s.val * 100 * 100) / 100) + "%";
          }
          html += `<li title="${tooltip}">${label}：${valText}</li>`;
        });
        html += `</ul></div>`;
      } else if (entry.type === "powerstone") {
        html += `<div class="break-block">
          <div>
            <span class="tag">PowerStone</span>
            <span class="tag">${entry.psName}</span>
          </div>
          <ul style="margin:4px 0 0 16px; padding:0;">`;
        entry.stats.forEach(s => {
          const def = STAT_DEFS[s.name];
          const label = def ? def.ui : s.name;
          const tooltip = def ? def.tooltip : s.name;
          let valText = s.val;
          if (def && def.kind === "percent") {
            valText = (Math.round(s.val * 100 * 100) / 100) + "%";
          }
          html += `<li title="${tooltip}">${label}：${valText}</li>`;
        });
        html += `</ul></div>`;
      }
    });
    breakArea.innerHTML = html;
  }
}

/* =======================
   レベル切り替え
   ======================= */
document.getElementById("levelSelect").addEventListener("click", (e) => {
  const btn = e.target.closest("button[data-level]");
  if (!btn) return;
  const lv = parseInt(btn.dataset.level, 10);
  currentLevel = lv;
  document.querySelectorAll("#levelSelect button").forEach(b => {
    b.classList.toggle("active", b === btn);
  });
  updateAll();
});

/* 盾ON/OFF */
document.getElementById("useShield").addEventListener("change", () => {
  buildSlots();
  updateAll();
});

/* 初期化 */
buildSlots();
buildPowerStoneUI();
updateAll();

</script>
</body>
</html>
